---
// src/layouts/Layout.astro
import { getTranslation } from '../i18n/utils.js';

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  ogImage?: string;
  canonicalURL?: string;
  noindex?: boolean;
  locale?: string;
}

/** Translation keys used by Layout (from i18n JSON). */
interface LayoutTranslations {
  meta: {
    site_title: string;
    site_description: string;
    keywords: string;
    author: string;
    site_name: string;
    og_image_alt: string;
    twitter_site: string;
    twitter_creator: string;
    twitter_image_alt: string;
  };
  schema: {
    organization_name: string;
    organization_description: string;
    address_region: string;
    offer_description: string;
    credential_awarded: string;
    catalog_name: string;
    course_southamerica_name: string;
    course_southamerica_description: string;
    course_europe_name: string;
    course_europe_description: string;
  };
  registration?: {
    closed?: {
      success_title?: string;
      success_message?: string;
      error_message?: string;
      email_required?: string;
    };
  };
}

const { 
  title, 
  description,
  keywords,
  ogImage = "/og-image-b4os.jpg",
  canonicalURL,
  noindex = false,
  locale = 'es'
} = Astro.props;

// Get translations for the current locale
const t = getTranslation(locale) as LayoutTranslations;

// Use translations as fallback if no props are provided
const pageTitle = title || t.meta.site_title;
const pageDescription = description || t.meta.site_description;
const pageKeywords = keywords || t.meta.keywords;

import '../styles/global.css';
import '../styles/nav.css';
import '../styles/carousel.css';
import '../styles/hero.css';

// Configure site base URL
const siteUrl = Astro.site ? Astro.site.toString() : 'https://b4os.dev';

// Generate canonical URL based on locale
let canonical;
if (canonicalURL) {
  canonical = canonicalURL;
} else {
  const basePath = Astro.url.pathname;
  if (locale === 'es') {
    canonical = `${siteUrl}${basePath}`;
  } else {
    // For other locales, ensure they have the prefix
    const cleanPath = basePath.replace(/^\/(en|pt)/, '');
    canonical = `${siteUrl}/${locale}${cleanPath === '/' ? '' : cleanPath}`;
  }
}

// Generate complete URL for Open Graph images
const ogImageUrl = ogImage.startsWith('http') ? ogImage : `${siteUrl.replace(/\/$/, '')}${ogImage.startsWith('/') ? ogImage : '/' + ogImage}`;

// Map locales to Open Graph codes
const ogLocaleMap: Record<string, string> = {
  es: 'es_ES',
  en: 'en_US',
  pt: 'pt_BR',
  ca: 'ca_ES'
};
const ogLocale = ogLocaleMap[locale] || 'es_ES';

// URLs for hreflang
const basePathClean = Astro.url.pathname.replace(/^\/(en|pt|ca)/, '') || '/';
const hrefLangUrls = {
  es: `${siteUrl}${basePathClean}`,
  en: `${siteUrl}/en${basePathClean === '/' ? '' : basePathClean}`,
  pt: `${siteUrl}/pt${basePathClean === '/' ? '' : basePathClean}`,
  ca: `${siteUrl}/ca${basePathClean === '/' ? '' : basePathClean}`
};
---

<!DOCTYPE html>
<html lang={locale} prefix="og: https://ogp.me/ns#">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Optimized title -->
    <title>{pageTitle}</title>
    
    <!-- Basic SEO meta -->
    <meta name="description" content={pageDescription}>
    <meta name="keywords" content={pageKeywords}>
    <meta name="author" content={t.meta.author}>
    <meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"}>
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonical}>
    
    <!-- Alternative languages -->
    <link rel="alternate" hreflang="es" href={hrefLangUrls.es}>
    <link rel="alternate" hreflang="en" href={hrefLangUrls.en}>
    <link rel="alternate" hreflang="pt" href={hrefLangUrls.pt}>
    <link rel="alternate" hreflang="ca" href={hrefLangUrls.ca}>
    <link rel="alternate" hreflang="x-default" href={hrefLangUrls.es}>
    
    <!-- Optimized Open Graph -->
    <meta property="og:locale" content={ogLocale}>
    <meta property="og:type" content="website">
    <meta property="og:site_name" content={t.meta.site_name}>
    <meta property="og:url" content={canonical}>
    <meta property="og:title" content={pageTitle}>
    <meta property="og:description" content={pageDescription}>
    <meta property="og:image" content={ogImageUrl}>
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content={t.meta.og_image_alt}>

    <!-- Optimized Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content={t.meta.twitter_site}>
    <meta name="twitter:creator" content={t.meta.twitter_creator}>
    <meta name="twitter:url" content={canonical}>
    <meta name="twitter:title" content={pageTitle}>
    <meta name="twitter:description" content={pageDescription}>
    <meta name="twitter:image" content={ogImageUrl}>
    <meta name="twitter:image:alt" content={t.meta.twitter_image_alt}>

    <!-- Optimized favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#f7931a">
    <meta name="msapplication-TileColor" content="#f7931a">
    
    <!-- DNS preconnections -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://restcountries.com">

    <!-- Preload fonts for early discovery -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

    <!-- Non-blocking fonts -->
    <link rel="stylesheet" 
          href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" 
          media="print" 
          onload="this.media='all'">

    <!-- Fallback for browsers without JS -->
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    </noscript>

    <!-- Prevent FOUT (flash of text without style) -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
    <!-- Structured JSON-LD data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "EducationalOrganization",
      "name": t.schema.organization_name,
      "description": t.schema.organization_description,
      "url": siteUrl,
      "logo": `${siteUrl}/b4os.png`,
      "foundingDate": "2025",
      "address": {
        "@type": "PostalAddress",
        "addressRegion": t.schema.address_region
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "email": "info@b4os.dev",
        "contactType": "admissions"
      },
      "offers": {
        "@type": "Offer",
        "category": "Education",
        "price": "0",
        "priceCurrency": "USD",
        "description": t.schema.offer_description
      },
      "educationalCredentialAwarded": t.schema.credential_awarded,
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": t.schema.catalog_name,
        "itemListElement": [
          {
            "@type": "Course",
            "name": t.schema.course_southamerica_name,
            "description": t.schema.course_southamerica_description,
            "provider": {
              "@type": "Organization",
              "name": "B4OS"
            }
          },
          {
            "@type": "Course", 
            "name": t.schema.course_europe_name,
            "description": t.schema.course_europe_description,
            "provider": {
              "@type": "Organization",
              "name": "B4OS"
            }
          }
        ]
      },
      "sameAs": [
        "https://twitter.com/libdesatoshi",
        "https://github.com/LibreriadeSatoshi"
      ]
    })} />
    
    <!-- Optimized Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K5KB3NMFS3"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-K5KB3NMFS3', {
        anonymize_ip: true,
        respect_dnq: true
      });
    </script>

    <!-- Waitlist translations for closed registration -->
    <script is:inline>
      window.waitlistTranslations = {
        success_title: '${t.registration.closed?.success_title || "Â¡Perfect!"}',
        success_message: '${t.registration.closed?.success_message || "We will notify you when we open registrations"}',
        error_message: '${t.registration.closed?.error_message || "There was a problem. Please try again"}',
        email_required: '${t.registration.closed?.email_required || "Please enter your email"}'
      };
    </script>

    <!-- Twitter conversion tracking base code for closed registration -->
    <script is:inline>
    !function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
    },s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='https://static.ads-twitter.com/uwt.js',
    a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
    twq('config','o3yxg');
    </script>
    <!-- End Twitter conversion tracking base code -->
</head>
<body>
    <slot />
    
    <!-- Optimized scripts -->
    <script>
        // @ts-nocheck - script block is processed as JS; JSDoc above documents types
        /**
         * @param {string} src
         * @param {() => boolean} checkFunction
         * @param {number} [timeout=5000]
         * @returns {Promise<void>}
         */
        async function loadScript(src, checkFunction, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.type = 'text/javascript';
                script.defer = true;
                
                let timeoutId = setTimeout(() => {
                    reject(new Error(`Timeout loading ${src}`));
                }, timeout);
                
                let checkInterval = setInterval(() => {
                    if (checkFunction()) {
                        clearTimeout(timeoutId);
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);
                
                script.onload = () => {
                    // File loaded
                };
                
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    clearInterval(checkInterval);
                    reject(new Error(`Failed to load ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        async function initializeB4OS() {
            try {
                // Load scripts in order
                await loadScript('/js/location-api.js', () => typeof window.LocationAPI !== 'undefined');
                await loadScript('/js/form-handler.js', () => typeof window.FormHandler !== 'undefined');
                await loadScript('/js/waitlist-handler.js', () => true);
                await loadScript('/js/nav.js', () => typeof window.NavigationHandler !== 'undefined');
                await loadScript('/js/carousel.js', () => typeof window.HeroCarousel !== 'undefined');
                await loadScript('/js/language-selector.js', () => typeof window.initLanguageSelector === 'function');
                await loadScript('/js/twitter-tracking.js', () => typeof window.TwitterSectionTracker !== 'undefined');

                // Load tracking specific to legal pages
                const isLegalPage = window.location.pathname.includes('terminos') ||
                                   window.location.pathname.includes('terms') ||
                                   window.location.pathname.includes('codigo-conducta') ||
                                   window.location.pathname.includes('conduct');

                if (isLegalPage) {
                    await loadScript('/js/legal-pages-tracking.js', () => typeof window.LegalPagesTracker !== 'undefined');
                }

                await loadScript('/js/main.js', () => true);
                
                // Initialize carousel if it's on the home page
                if (document.querySelector('.hero-carousel')) {
                    window.initHeroCarousel();
                }

                // Initialize language selector if it's available
                if (typeof window.initLanguageSelector === 'function') {
                    window.initLanguageSelector();
                }
                                
                const form = document.getElementById('registrationForm');
                if (!form) return;
                
                // Initialize form handler (without direct Customer.io)
                const formHandler = new window.FormHandler();
                await formHandler.init();
                
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    window.debugFormHandler = formHandler;
                    window.clearLocationCache = () => formHandler.clearLocationCache();
                }
                
            } catch (error) {
                console.error('Error initializing B4OS:', error);
                
                // Silent fallback
                let scripts = ['/js/location-api.js', '/js/form-handler.js', '/js/waitlist-handler.js', '/js/nav.js', '/js/carousel.js', '/js/language-selector.js', '/js/twitter-tracking.js'];

                // Add script for legal pages if necessary
                const isLegalPage = window.location.pathname.includes('terminos') ||
                                   window.location.pathname.includes('terms') ||
                                   window.location.pathname.includes('codigo-conducta') ||
                                   window.location.pathname.includes('conduct');

                if (isLegalPage) {
                    scripts.push('/js/legal-pages-tracking.js');
                }

                scripts.push('/js/main.js');
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.defer = true;
                    document.head.appendChild(script);
                });
                
                setTimeout(async () => {
                    // Try to initialize navigation if available
                    if (typeof window.NavigationHandler !== 'undefined') {
                        const nav = new window.NavigationHandler();
                        nav.init();
                    }
                    // Try to initialize language selector if available
                    if (typeof window.initLanguageSelector === 'function') {
                        window.initLanguageSelector();
                    }
                    
                    // Initialize carousel if available
                    if (typeof window.initHeroCarousel !== 'undefined') {
                        window.initHeroCarousel();
                    }

                    if (typeof window.FormHandler !== 'undefined') {
                        const form = document.getElementById('registrationForm');
                        if (form) {
                            try {
                                const formHandler = new window.FormHandler();
                                await formHandler.init();
                                if (window.location.hostname === 'localhost') {
                                    window.debugFormHandler = formHandler;
                                }
                            } catch (fallbackError) {
                                // Silent in production
                            }
                        }
                    }
                }, 1000);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeB4OS);
        } else {
            setTimeout(initializeB4OS, 50);
        }
    </script>
</body>
</html>